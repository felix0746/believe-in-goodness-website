<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後台管理 - 相信善良</title>
    
    <!-- Favicon -->
    <link rel="icon" href="images/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="apple-touch-icon" href="images/logo.png">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">
    <!-- 引入 Firebase -->
    <script type="module">
        // 匯入 Firebase 所需的函式
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCtMlFZVNvUHfvt-6Z03ucLVQdJ7E1o6Iw",
            authDomain: "miss-blog-backend-92eb6.firebaseapp.com",
            projectId: "miss-blog-backend-92eb6",
            storageBucket: "miss-blog-backend-92eb6.firebasestorage.app",
            messagingSenderId: "674705041997",
            appId: "1:674705041997:web:e56636babe5a50359f4a04",
            measurementId: "G-KDY1SRL463"
        };

        // --- DOM 元素 ---
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const updateForm = document.getElementById('update-form');
        const talentInput = document.getElementById('talent-input');
        const partnersInput = document.getElementById('partners-input');
        const jobsInput = document.getElementById('jobs-input');
        const statusMessage = document.getElementById('status-message');
        
        // --- 初始化 Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- 設定驗證邏輯 ---
        function setupAuthListeners(auth, db) {
            // 監聽使用者登入狀態
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loginSection.style.display = 'none';
                    adminPanel.style.display = 'block';
                    loadCurrentNumbers(db); // 載入資料
                } else {
                    loginSection.style.display = 'block';
                    adminPanel.style.display = 'none';
                }
            });

            // 登出
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("登出失敗:", error);
                    alert("登出時發生錯誤。");
                }
            });
        }
        
        // --- 設定表單事件 ---
        function setupFormListeners(auth, db) {
            // Email/密碼 登入
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                loginError.textContent = ''; // 清除舊的錯誤訊息

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("登入失敗:", error);
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            loginError.textContent = '電子郵件或密碼錯誤。';
                            break;
                        default:
                            loginError.textContent = '登入時發生錯誤，請稍後再試。';
                    }
                }
            });

            // 更新數字到資料庫
            updateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                statusMessage.textContent = '更新中...';
                statusMessage.style.color = '#333';

                if (!auth.currentUser) {
                    statusMessage.textContent = '驗證已過期，請重新整理頁面再試。';
                    statusMessage.style.color = 'red';
                    return;
                }

                const newData = {
                    talent: parseInt(talentInput.value, 10),
                    partners: parseInt(partnersInput.value, 10),
                    jobs: parseInt(jobsInput.value, 10)
                };

                try {
                    await setDoc(doc(db, "impact", "numbers"), newData, { merge: true });
                    statusMessage.textContent = '✅ 數字已成功更新！';
                    statusMessage.style.color = 'green';
                } catch (error) {
                    console.error("更新數據時發生錯誤: ", error);
                    statusMessage.textContent = '更新失敗，請檢查 Firebase 安全規則或網路連線。';
                    statusMessage.style.color = 'red';
                }
            });
        }
        
        // --- 資料庫邏輯 ---
        async function loadCurrentNumbers(db) {
            const docRef = doc(db, "impact", "numbers");
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    talentInput.value = data.talent || 0;
                    partnersInput.value = data.partners || 0;
                    jobsInput.value = data.jobs || 0;
                } else {
                    console.log("資料庫中尚無數據，將使用預設值 0。");
                }
            } catch (error) {
                console.error("讀取數據時發生錯誤: ", error);
                statusMessage.textContent = '讀取數據時出錯！';
                statusMessage.style.color = 'red';
            }
        }

        // --- 執行初始化 ---
        setupAuthListeners(auth, db);
        setupFormListeners(auth, db);
    </script>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>影響力數字 - 後台管理</h1>
        </header>

        <section id="login-section">
            <form id="login-form" class="admin-form">
                <h2>管理員登入</h2>
                <div class="form-group">
                    <label for="email">電子郵件</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">密碼</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="admin-button">登入</button>
                <p id="login-error" style="color: red;"></p>
            </form>
        </section>

        <section id="admin-panel" style="display: none;">
            <form id="update-form" class="admin-form">
                <h2>更新影響力數字</h2>
                <div class="form-group">
                    <label for="talent-input">培育人才 (人)</label>
                    <input type="number" id="talent-input" required>
                </div>
                <div class="form-group">
                    <label for="partners-input">合作單位與機構 (間)</label>
                    <input type="number" id="partners-input" required>
                </div>
                <div class="form-group">
                    <label for="jobs-input">創造餐飲就業機會 (份)</label>
                    <input type="number" id="jobs-input" required>
                </div>
                <button type="submit" class="admin-button">儲存更新</button>
                <p id="status-message"></p>
            </form>
            <button id="logout-button" class="admin-button" style="background-color: #d9534f; margin-top: 20px;">登出</button>
        </section>
    </div>
</body>
</html>
